<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="&#34;auto&#34;"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png"><link rel="icon" type="image/png" href="/img/favicon.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="description" content=""><meta name="author" content="Ziyang Xie"><meta name="keywords" content=""><title>计网传输层 - 可靠传输协议实验 - ZiYang&#39;s Blog</title><link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.5.3/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="/lib/hint/hint.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.1.2/styles/github-gist.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css"><link rel="stylesheet" href="/css/main.css"><script id="fluid-configs">var Fluid=window.Fluid||{},CONFIG={hostname:"xcraft.tech",root:"/",version:"1.8.5",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1},toc:{enable:!0,headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"right",visible:"hover",icon:""},copy_btn:!0,image_zoom:{enable:!0},lazyload:{enable:!0,onlypost:!1},web_analytics:{enable:!1,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null}}}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 5.4.2"></head><body><header style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/">&nbsp;<strong>ZiYang-Xie's Blog</strong>&nbsp;</a> <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> 首页</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> 归档</a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> 分类</a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> 标签</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item" id="search-btn"><a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" href="javascript:">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div class="banner intro-2" id="background" parallax="true" style="background:url(/img/bg_in.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="page-header text-center fade-in-up"><span class="h2" id="subtitle" title="计网传输层 - 可靠传输协议实验"></span><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2021-11-24 01:02" pubdate>2021年11月24日 凌晨</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 1.3k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 14 分钟</span></div></div></div></div></div></header><main><div class="container-fluid"><div class="row"><div class="d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-md"><div class="container nopadding-md" id="board-ctn"><div class="py-5" id="board"><article class="post-content mx-auto"><h1 style="display:none">计网传输层 - 可靠传输协议实验</h1><div class="markdown-body"><h1 id="计网传输层-可靠传输协议实验"><a href="#计网传输层-可靠传输协议实验" class="headerlink" title="计网传输层 - 可靠传输协议实验"></a>计网传输层 - 可靠传输协议实验</h1><p><em>代码连接： <a target="_blank" rel="noopener" href="https://github.com/ZiYang-xie/RDT_protocol">ZiYang-xie/RDT_protocol (github.com)</a></em></p><h2 id="1-实验简介"><a href="#1-实验简介" class="headerlink" title="1. 实验简介"></a>1. 实验简介</h2><p>​ 本次实验要求完成 rdt3.0 基础停等协议的模拟，以及进阶的GBN和SR协议的实现。我们知道网络层的IP协议是不保证报文段按顺序正确交付，其只是“尽力而为”，因此在传输层中TCP需要实现可靠的传输协议为上层应用层提供可靠的传输支持。RDT3.0是最基础的可靠传输协议，其可以保证报文按序正确交付。而GBN和SR则在RDT3.0基础上添加了流水线架构，并且支持顺序or乱序ACK，从而进一步提升协议的速度。</p><h2 id="2-实验内容"><a href="#2-实验内容" class="headerlink" title="2. 实验内容"></a>2. 实验内容</h2><p>​ 实验的代码结构如下图所示，我们需要完成 A_output(), A_input(), A_timerinterrupt(), A_init(), B_input(), B_init()等函数的补充。</p><p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gwo9yfv0m8j30oc0dgjsk.jpg" srcset="/img/loading.gif" style="zoom:50%"></p><h3 id="2-1-RDT3-0-Alternating-Bit"><a href="#2-1-RDT3-0-Alternating-Bit" class="headerlink" title="2.1 RDT3.0 (Alternating Bit)"></a>2.1 RDT3.0 (Alternating Bit)</h3><p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gwoa2hbtkaj31i40fyact.jpg" srcset="/img/loading.gif" alt="image-20211122220544951"></p><p>​ 其基本逻辑如上图所示，在实现代码的时候需要注意的是，通过一个标识位来标记当前状态来实现状态机。如果在ACK的等待状态接受到了上层的调用，则需要把报文先缓存下来，再到接受到ACK的时候检查缓存，按顺序发送。</p><pre><code class="hljs c"><span class="hljs-keyword">if</span> (STATE == WAIT)&#123;
  	inform(__FUNCTION__, <span class="hljs-string">&quot;Not yet acked, Buffer the Msg: %.20s&quot;</span>, message.data);
  	cache_msg(&amp;message);
  	<span class="hljs-keyword">return</span>;
&#125;</code></pre><p>​ 当 <code>checksum</code> 失败和收到重复的 <code>ACK</code> 的时候，需要重传上一次的分组。</p><p>​ 报文的缓存使用循环队列模式，基础实现则是通过一个固定大小（足够大）的数组，加上循环的index实现。</p><h3 id="2-2-Go-Back-N"><a href="#2-2-Go-Back-N" class="headerlink" title="2.2 Go Back N"></a>2.2 Go Back N</h3><p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gwoaepdhylj31800aamyj.jpg" srcset="/img/loading.gif" style="zoom:50%"></p><p>​ Go Back N 需要注意<strong>累计确认</strong>， 即 ACK(n): ACKs 所有n之前(包含n)的分组，同时定时器对应最老的那个没被ACK的分组。如果仅 ACK 窗口最左边的分组，会出现如下情况。</p><p>​</p><p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gwoahl3tgfj30zy0qkdi5.jpg" srcset="/img/loading.gif" style="zoom:30%"></p><p>​ 在传送分组的时候丢失了两个ACK，但因为没有 ACK0 整个系统就会陷入无限循环的卡死状态。GBN需要注意累计确认，将窗口滑到对应的位置，接收端的ACK发送正常接收的最后一个分组。</p><h3 id="2-3-选择重传-Selective-Repeat"><a href="#2-3-选择重传-Selective-Repeat" class="headerlink" title="2.3 选择重传 (Selective Repeat)"></a>2.3 选择重传 (Selective Repeat)</h3><p>​</p><p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gwoakrl3tnj31760owwhx.jpg" srcset="/img/loading.gif" style="zoom:50%"></p><p>​ 选择重传因为可以直接ACK乱序的分组，但是同时要保证交付到上层应用层的顺序，因此其在接收端也同样需要一个缓冲区，这个大小就为窗口大小，来暂存收到的报文段。当前面的报文全部被接受的时候就统一移动窗口，同样的对于发送端，当前面的报文全部被ACK之后可以移动窗口。</p><p>​ 因此需要对缓冲区的内容进行标记，在实现中我是选用通过对传输报文的第一个字节标记 <code>\0</code> 来实现的。对于发送方，在缓冲区中如果被标记 <code>\0</code> 则说明该位置可写，即尚未存放分组或已经是离开窗口区域。</p><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">clean_pkt</span><span class="hljs-params">(<span class="hljs-keyword">char</span> (*buffer)[<span class="hljs-number">20</span>], <span class="hljs-keyword">uint32_t</span> loc)</span></span>
<span class="hljs-function"></span>&#123;
    buffer[loc][<span class="hljs-number">0</span>] = <span class="hljs-string">&#x27;\0&#x27;</span>;
&#125;</code></pre><h2 id="3-性能测试"><a href="#3-性能测试" class="headerlink" title="3. 性能测试"></a>3. 性能测试</h2><h3 id="3-0-参数设置"><a href="#3-0-参数设置" class="headerlink" title="3.0 参数设置"></a>3.0 参数设置</h3><pre><code class="hljs yaml"><span class="hljs-comment">#define TIMEOUT 20</span>
<span class="hljs-comment">#define BUF_SZ 10000</span>
<span class="hljs-comment">#define WINDOW_SZ 10</span></code></pre><h3 id="3-1-基础情况-无丢包和损坏"><a href="#3-1-基础情况-无丢包和损坏" class="headerlink" title="3.1 基础情况 (无丢包和损坏)"></a>3.1 基础情况 (无丢包和损坏)</h3><ul><li><code>参数: 10 0 0 10</code></li></ul><blockquote><p>altBit: 139.041168ms<br>goBackN: 124.61444100000003ms<br>selectiveRepeat: 119.80553200000004ms</p></blockquote><ul><li><code>参数: 100 0 0 10</code></li></ul><blockquote><p>altBit: 1172.531616ms<br>goBackN: 1058.7275695000003ms<br>selectiveRepeat: 1020.7928873333335ms</p></blockquote><p>​ 可以看到，在无丢包损坏的情况下，选择重传因为可以乱序ACK而占有优势，GBN因为流水线结构而速度较快，AltBit因为停等是速度最慢的。</p><h3 id="3-2-丢包差错情况"><a href="#3-2-丢包差错情况" class="headerlink" title="3.2 丢包差错情况"></a>3.2 丢包差错情况</h3><ul><li>少量丢包和差错 <code>参数: 10 0.1 0.1 10</code></li></ul><blockquote><p>altBit: 247.166718ms<br>goBackN: 219.95912200000004ms<br>selectiveRepeat: 227.78014633333336m</p></blockquote><ul><li>大量丢包和差错 <code>参数：10 0.5 0.5 10</code></li></ul><blockquote><p>altBit: 3346.8271479999994ms<br>goBackN: 2001.064117ms<br>selectiveRepeat: 2813.4893593333336ms</p></blockquote><p>​ 在丢包和损坏情况下，可以看到 GBN 和 SR 都起到了非常不错的作用，和 AltBit 拉开了差距。但我们同时可以看到 GBN 比 SR 的效果更好，这是因为在丢包的情况下，GBN可以直接重传全部，而性能损失较小。但SR因为要在接收端维护缓冲区，所以有一定的性能损失。</p><h3 id="3-3-快速大量发包情况"><a href="#3-3-快速大量发包情况" class="headerlink" title="3.3 快速大量发包情况"></a>3.3 快速大量发包情况</h3><p>我进而测试了较为极限情况下的大量快速发包的效果对比。可以发现选择重传在这种情况下比较占优。得益于其乱序 ACK 的设计</p><ul><li>快速大量包 <code>参数: 1000 0 0 0.1</code></li></ul><blockquote><p>altBit: 11117.566406ms<br>goBackN: 8406.244140499999ms<br>selectiveRepeat: 7456.902832000002ms</p></blockquote><h2 id="4-总结"><a href="#4-总结" class="headerlink" title="4. 总结"></a>4. 总结</h2><p>​ 本次实验中，通过代码模拟实现了可靠数据传输的基础版本 RDT3.0 以及其进阶GBN和SR协议的实现，更加深入的理解了可靠数据传输的工作原理。</p><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><p>除了固定随机参数以外，测试代码中还提供了多次实验取均值的接口，以进一步测试。</p><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">multi_test</span>(<span class="hljs-params">N</span>):</span>
    time_list = []
    <span class="hljs-keyword">for</span> protocol <span class="hljs-keyword">in</span> protocol_list:
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(N):
            time = test_time(protocol, args)
            time_list.append(<span class="hljs-built_in">float</span>(time))
        avg_time = np.mean(time_list)
        print(<span class="hljs-string">f&#x27;[<span class="hljs-subst">&#123;protocol&#125;</span>]: <span class="hljs-subst">&#123;avg_time&#125;</span>ms&#x27;</span>)</code></pre><ul><li><strong>部分实验截图</strong></li></ul><p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gwoc6uggs1j30e00g7gno.jpg" srcset="/img/loading.gif" alt></p></div><hr><div><div class="post-metas mb-3"><div class="post-meta mr-3"><i class="iconfont icon-category"></i> <a class="hover-with-bg" href="/categories/Network/">Network</a></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a class="hover-with-bg" href="/tags/RDT/">RDT</a> <a class="hover-with-bg" href="/tags/GBN/">GBN</a> <a class="hover-with-bg" href="/tags/SR/">SR</a></div></div><p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p><div class="post-prevnext row"><article class="post-prev col-6"><a href="/2021/11/24/NLP/nlp-sst/"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">NLP 情感分类任务</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2021/11/15/OS/Unix/"><span class="hidden-mobile">「论文阅读」The Unix Time-Sharing System</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article class="comments" id="comments"><div id="gitalk-container"></div><script type="text/javascript">Fluid.utils.waitElementVisible("gitalk-container",(function(){Fluid.utils.createCssLink("/css/gitalk.css"),Fluid.utils.createScript("https://cdn.staticfile.org/gitalk/1.7.0/gitalk.min.js",(function(){new Gitalk({clientID:"bb132e59582b2e328abc",clientSecret:"884bfc0ac692d040744d5e4b81ffd6f1aa95cbc0",repo:"CsBlog",owner:"ZiYang-xie",admin:["ZiYang-xie"],id:"c08dc7e2aeb43f6b0de2b9ea4a7b50b2",language:"zh-CN",labels:["Gitalk"],perPage:10,pagerDirection:"last",createIssueManually:!0,distractionFreeMode:!1}).render("gitalk-container")}))}))</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div class="toc-body" id="toc-body"></div></div></div></div></div><a id="scroll-top-button" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer class="text-center mt-5 py-3"><div class="footer-content"><p>Fight For The Happiness of Humanity</p><div><span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span><script src="/js/duration.js"></script></div></div><div class="statistics"><span id="busuanzi_container_site_pv" style="display:none">总访问量 <span id="busuanzi_value_site_pv"></span> 次 </span><span id="busuanzi_container_site_uv" style="display:none">总访客数 <span id="busuanzi_value_site_uv"></span> 人</span></div><div class="beian"><a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">沪ICP备20009486号-1</a></div></footer><script src="https://cdn.staticfile.org/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://cdn.staticfile.org/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:200}),NProgress.start(),document.addEventListener("DOMContentLoaded",(function(){window.NProgress&&window.NProgress.inc()})),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://cdn.staticfile.org/jquery/3.5.1/jquery.min.js"></script><script src="https://cdn.staticfile.org/twitter-bootstrap/4.5.3/js/bootstrap.min.js"></script><script src="/js/debouncer.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="/js/lazyload.js"></script><script src="https://cdn.staticfile.org/tocbot/4.12.0/tocbot.min.js"></script><script src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js"></script><script src="https://cdn.staticfile.org/anchor-js/4.3.0/anchor.min.js"></script><script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js"></script><script>!function(t,i){(0,Fluid.plugins.typing)(i.getElementById("subtitle").title)}(window,document)</script><script src="/js/local-search.js"></script><script>document.querySelector("#local-search-input").onclick=function(){searchFunc("/local-search.xml","local-search-input","local-search-result"),this.onclick=null}</script><script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]]},options:{renderActions:{findScript:[10,e=>{document.querySelectorAll('script[type^="math/tex"]').forEach(t=>{const n=!!t.type.match(/; *mode=display/),o=new e.options.MathItem(t.textContent,e.inputJax[0],n),a=document.createTextNode("");t.parentNode.replaceChild(a,t),o.start={node:a,delim:"",n:0},o.end={node:a,delim:"",n:0},e.math.push(o)})},"",!1],insertedScript:[200,()=>{document.querySelectorAll("mjx-container").forEach(e=>{let t=e.parentNode;"li"===t.nodeName.toLowerCase()&&t.parentNode.classList.add("has-jax")})},"",!1]}}}</script><script async src="https://cdn.staticfile.org/mathjax/3.1.2/es5/tex-svg.js"></script><script src="/js/boot.js"></script></body></html>